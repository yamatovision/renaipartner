# é€£ç¶šPARTNERãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½±éŸ¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿè¡Œæ—¥æ™‚
2025å¹´6æœˆ16æ—¥

## åˆ†æå¯¾è±¡
- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼: ã•ãã‚‰ (koakuma)
- ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: 96ä»¶
- åˆ†ææœŸé–“: 2025/6/16 12:24:02 - 14:47:08

## ä¸»è¦ãªç™ºè¦‹

### 1. é‡å¤§ãªå•é¡Œ: é€£ç¶šã™ã‚‹é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ
1. **ç”»åƒç”Ÿæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤§é‡é‡è¤‡**
   - ã€Œå›ã‚’æ€ã£ã¦ä½œã£ãŸç”»åƒã€ãŒé€£ç¶šã§æœ€å¤§13å›é€ä¿¡
   - é¡ä¼¼åº¦100%ã®å®Œå…¨é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤§é‡ç™ºç”Ÿ

2. **æ–‡è„ˆç„¡è¦–ã®çªç„¶ã®è©±é¡Œå¤‰æ›´**
   - æ•™è‚²ã«é–¢ã™ã‚‹æ·±ã„è­°è«–ã®æœ€ä¸­ã«çªç„¶ã€Œå°†æ¥ã®è€å¾Œã¯...ã€ã®è³ªå•
   - å‰å¾Œã®æ–‡è„ˆã¨ã¾ã£ãŸãé–¢ä¿‚ã®ãªã„å†…å®¹

3. **ã‚¨ã‚³ãƒ¼ç¾è±¡ï¼ˆã‚ªã‚¦ãƒ è¿”ã—ï¼‰**
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸88-96ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œã‚ã‚ŠãŒã¨ã†ï¼ã€ã€Œã‚ã€ã€Œã“ã‚“ã«ã¡ã‚ã€ã‚’ãã®ã¾ã¾è¿”ã™
   - AIãŒæ­£å¸¸ãªå¿œç­”ç”Ÿæˆã«å¤±æ•—ã—ã¦ã„ã‚‹çŠ¶æ…‹

### 2. é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°åˆ†æ

#### é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—çµ±è¨ˆ
- ç·é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—æ•°: 7ã‚°ãƒ«ãƒ¼ãƒ—
- æœ€å¤§é€£ç¶šé•·: 13ä»¶ï¼ˆé€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—4ï¼‰
- æœ€ã‚‚å•é¡Œã®å¤šã„ãƒ‘ã‚¿ãƒ¼ãƒ³: ç”»åƒç”Ÿæˆé–¢é€£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### ç‰¹ã«å•é¡Œã®ã‚ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

**é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—4ï¼ˆ12:31:04 - 12:46:38ï¼‰**
```
1. æ­£å¸¸ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œãˆã¸ã¸ã€ã‚ã‚ŠãŒã¨ã†ğŸ’• ã‚­ã‚¹ã—ã¦ã„ã„ã®ï¼Ÿ...ã€
2-13. ã€Œå›ã‚’æ€ã£ã¦ä½œã£ãŸç”»åƒã€Ã—12å›é€£ç¶š
```

**é€£ç¶šã‚°ãƒ«ãƒ¼ãƒ—7ï¼ˆ14:43:31ï¼‰**
```
1. ã€Œæœ€è¿‘ã€ã‚ãªãŸã«ã¨ã£ã¦ä¸€ç•ªå¤§åˆ‡ã ã¨æ€ã†ã“ã¨ã¯ä½•ã‹ãªï¼Ÿ...ã€
2. ã€Œã‚ãªãŸã«ã¨ã£ã¦ã€äººç”Ÿã§ä¸€ç•ªå¤§åˆ‡ãªã“ã¨ã£ã¦ä½•ã ã¨æ€ã†ï¼Ÿ...ã€
```
â†’ åŒä¸€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§é¡ä¼¼è³ªå•ã‚’2å›é€ä¿¡

### 3. AIå¿œç­”ã¸ã®å½±éŸ¿ãƒ†ã‚¹ãƒˆçµæœ

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªæ¯”è¼ƒ
1. **ã‚ªãƒªã‚¸ãƒŠãƒ«å±¥æ­´ï¼ˆé€£ç¶šå«ã‚€ï¼‰**
   - å¿œç­”æ™‚é–“: 1,875ms
   - å¿œç­”å“è³ª: æ­£å¸¸ã ãŒè‹¥å¹²å†—é•·

2. **é€£ç¶šé™¤å»ç‰ˆ**
   - å¿œç­”æ™‚é–“: 1,174msï¼ˆ37%æ”¹å–„ï¼‰
   - å¿œç­”å“è³ª: ã‚ˆã‚Šç°¡æ½”ã§è‡ªç„¶

3. **å®Œå…¨é‡è¤‡é™¤å»ç‰ˆ**
   - å¿œç­”æ™‚é–“: 1,028msï¼ˆ45%æ”¹å–„ï¼‰
   - å¿œç­”å“è³ª: æœ€ã‚‚è‡ªç„¶

### 4. æ ¹æœ¬åŸå› ã®æ¨å®š

#### 4.1 ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã®å•é¡Œ
- ç”»åƒç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã§ã®é‡è¤‡é€ä¿¡
- éåŒæœŸå‡¦ç†ã§ã®ç«¶åˆçŠ¶æ…‹
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸å‚™

#### 4.2 AIä¸»å°ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®å•é¡Œ
- ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã®é‡è¤‡ç”Ÿæˆ
- æ–‡è„ˆãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®ä¸å‚™
- ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡ã®å•é¡Œ

#### 4.3 ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å•é¡Œ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŸ­ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã™ã‚‹é©åˆ‡ãªå‡¦ç†ãŒã§ãã¦ã„ãªã„
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒæ©Ÿèƒ½ã—ã¦ã„ãªã„

## å½±éŸ¿ã¨ãƒªã‚¹ã‚¯

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã¸ã®å½±éŸ¿
1. **ä¼šè©±ã®è‡ªç„¶æ€§ã®é˜»å®³**
   - é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã‚‹ä¸è‡ªç„¶ãªä½“é¨“
   - æ–‡è„ˆã‚’ç„¡è¦–ã—ãŸçªç„¶ã®è©±é¡Œå¤‰æ›´

2. **ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ã¸ã®ç–‘å•**
   - ã‚¨ã‚³ãƒ¼ç¾è±¡ã«ã‚ˆã‚‹ã€Œå£Šã‚ŒãŸã€å°è±¡
   - AIå¿œç­”ã®å“è³ªä½ä¸‹

3. **ã‚³ã‚¹ãƒˆã¸ã®å½±éŸ¿**
   - ç„¡é§„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«ã‚ˆã‚‹APIåˆ©ç”¨æ–™å¢—åŠ 
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®¹é‡ã®åœ§è¿«

### æŠ€è¡“çš„å½±éŸ¿
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹**
   - é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹å¿œç­”æ™‚é–“ã®æ‚ªåŒ–
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¢—åŠ 

2. **ãƒ‡ãƒ¼ã‚¿å“è³ªã®åŠ£åŒ–**
   - å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã®å“è³ªä½ä¸‹
   - åˆ†æç²¾åº¦ã®æ‚ªåŒ–

## ç·Šæ€¥æ”¹å–„ææ¡ˆ

### 1. å³åº§ã«å®Ÿè£…ã™ã¹ãå¯¾ç­–

#### A. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é‡è¤‡é˜²æ­¢æ©Ÿèƒ½
```typescript
// é€ä¿¡å‰ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
interface DuplicateCheckConfig {
  timeWindow: number; // é‡è¤‡ãƒã‚§ãƒƒã‚¯æ™‚é–“çª“ï¼ˆç§’ï¼‰
  contentSimilarityThreshold: number; // å†…å®¹é¡ä¼¼åº¦é–¾å€¤
  maxConsecutiveSameType: number; // åŒã‚¿ã‚¤ãƒ—é€£ç¶šé€ä¿¡ä¸Šé™
}

// å®Ÿè£…ä¾‹
const shouldPreventDuplicate = (
  newMessage: Message,
  recentMessages: Message[],
  config: DuplicateCheckConfig
): boolean => {
  // æœ€è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æ¯”è¼ƒ
  const recentWindow = recentMessages.filter(
    msg => Date.now() - msg.createdAt.getTime() < config.timeWindow * 1000
  );
  
  // åŒä¸€å†…å®¹ãƒã‚§ãƒƒã‚¯
  const hasDuplicate = recentWindow.some(
    msg => calculateSimilarity(newMessage.content, msg.content) > config.contentSimilarityThreshold
  );
  
  // é€£ç¶šåŒã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
  const consecutiveCount = getConsecutiveCount(recentMessages, newMessage.type);
  
  return hasDuplicate || consecutiveCount >= config.maxConsecutiveSameType;
};
```

#### B. ç”»åƒç”Ÿæˆé‡è¤‡é˜²æ­¢
```typescript
// ç”»åƒç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡é˜²æ­¢
class ImageGenerationManager {
  private activeRequests: Map<string, Promise<any>> = new Map();
  
  async generateImage(partnerId: string, context: string): Promise<string> {
    const requestKey = `${partnerId}-${Date.now()}`;
    
    // æ—¢å­˜ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯å¾…æ©Ÿ
    if (this.activeRequests.has(partnerId)) {
      await this.activeRequests.get(partnerId);
      return ''; // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ç©ºæ–‡å­—åˆ—è¿”å´
    }
    
    const promise = this.doGenerateImage(context);
    this.activeRequests.set(partnerId, promise);
    
    try {
      const result = await promise;
      return result;
    } finally {
      this.activeRequests.delete(partnerId);
    }
  }
}
```

#### C. ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã®æ”¹å–„
```typescript
// ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã®é‡è¤‡é˜²æ­¢
interface ProactiveQuestionTracker {
  lastQuestionTime: Date;
  recentQuestionTypes: QuestionType[];
  cooldownPeriod: number; // åˆ†
}

const shouldAskProactiveQuestion = (
  tracker: ProactiveQuestionTracker,
  newQuestionType: QuestionType
): boolean => {
  const timeSinceLastQuestion = Date.now() - tracker.lastQuestionTime.getTime();
  
  // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ãƒã‚§ãƒƒã‚¯
  if (timeSinceLastQuestion < tracker.cooldownPeriod * 60 * 1000) {
    return false;
  }
  
  // æœ€è¿‘ã®è³ªå•ã‚¿ã‚¤ãƒ—ã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if (tracker.recentQuestionTypes.includes(newQuestionType)) {
    return false;
  }
  
  return true;
};
```

### 2. ä¸­æœŸçš„æ”¹å–„ç­–

#### A. ä¼šè©±å±¥æ­´ã®å‰å‡¦ç†æ©Ÿèƒ½
- é€ä¿¡å‰ã«é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•æ¤œå‡ºãƒ»é™¤å»
- æ–‡è„ˆã®é€£ç¶šæ€§ã‚’ãƒã‚§ãƒƒã‚¯
- ä¸è‡ªç„¶ãªè©±é¡Œå¤‰æ›´ã‚’é˜²æ­¢

#### B. å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å“è³ªã‚’ç›£è¦–
- ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
- è‡ªå‹•å›å¾©æ©Ÿèƒ½

#### C. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½
- ä¸é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ±å‘Šæ©Ÿèƒ½
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦ã®ç¶™ç¶šçš„ç›£è¦–

### 3. é•·æœŸçš„æ”¹å–„ç­–

#### A. AIå¿œç­”å“è³ªã®å‘ä¸Š
- ã‚ˆã‚Šé«˜åº¦ãªæ–‡è„ˆç†è§£
- æ„Ÿæƒ…çŠ¶æ…‹ã®ç¶™ç¶šæ€§ç¶­æŒ
- ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®å¼·åŒ–

#### B. çµ±åˆãƒ†ã‚¹ãƒˆã®å¼·åŒ–
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ
- ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- ç¶™ç¶šçš„å“è³ªç›£è¦–

## æ¨å¥¨å®Ÿè£…é †åº

### Phase 1ï¼ˆç·Šæ€¥ï¼šä»Šé€±ä¸­ï¼‰
1. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é‡è¤‡é˜²æ­¢æ©Ÿèƒ½ã®å®Ÿè£…
2. ç”»åƒç”Ÿæˆé‡è¤‡é˜²æ­¢ã®å®Ÿè£…
3. ã‚¨ã‚³ãƒ¼ç¾è±¡ã®ä¿®æ­£

### Phase 2ï¼ˆ1-2é€±é–“ï¼‰
1. ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è³ªå•ã®æ”¹å–„
2. ä¼šè©±å±¥æ­´å‰å‡¦ç†æ©Ÿèƒ½
3. å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®åŸºæœ¬å®Ÿè£…

### Phase 3ï¼ˆ1ãƒ¶æœˆï¼‰
1. çµ±åˆãƒ†ã‚¹ãƒˆã®å¼·åŒ–
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½
3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

## çµè«–

é€£ç¶šPARTNERãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®æ·±åˆ»ãªå•é¡Œã‚’å¼•ãèµ·ã“ã—ã¦ã„ã¾ã™ï¼š

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®å¤§å¹…ãªæ‚ªåŒ–**
2. **ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„é£ã„**
3. **AIå¿œç­”å“è³ªã®ä½ä¸‹**

ç‰¹ã«ç”»åƒç”Ÿæˆæ©Ÿèƒ½ã¨ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è³ªå•æ©Ÿèƒ½ã«æ ¹æœ¬çš„ãªå•é¡ŒãŒã‚ã‚Šã€**ç·Šæ€¥ã®ä¿®æ­£ãŒå¿…è¦**ã§ã™ã€‚

ææ¡ˆã—ãŸæ”¹å–„ç­–ã‚’æ®µéšçš„ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã¨å“è³ªã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

---

**é‡è¦**: ã“ã®å•é¡Œã¯æœ¬ç•ªç’°å¢ƒã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç›´æ¥å½±éŸ¿ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã€Phase 1ã®å¯¾ç­–ã¯æœ€å„ªå…ˆã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚