# リファクタリング計画: 場所システム統合 2024-06-15

## 1. 現状分析

### 1.1 対象概要
ホーム画面のピンマークで選択した場所情報がシステムプロンプトやチャット画像生成に反映されない問題を修正する。現在、場所選択UIとロジックは実装済みだが、データの永続化とAPIリクエスト時の場所情報送信が不完全な状態。

### 1.2 問題点と課題
- **現在地情報のDB保存不完全**: `partners`テーブルに`current_location_id`カラムが存在しない
- **バックエンドDB更新処理未実装**: `LocationsService.updatePartnerLocation`でDB更新がコメントアウト
- **フロントエンドAPIリクエスト不備**: メッセージ送信時に`locationId`が含まれない
- **データフロー断絶**: フロントエンドで選択した場所がバックエンドのシステムプロンプト生成まで到達しない

### 1.3 関連ファイル一覧
- `backend/src/db/models/Partner.model.ts`
- `backend/src/features/locations/locations.service.ts`
- `backend/src/features/chat/chat.service.ts`
- `backend/src/features/images/images.service.ts`
- `frontend/src/services/api/chat.api.ts`
- `frontend/app/home/page.tsx`
- `frontend/src/contexts/LocationContext.tsx`
- `frontend/src/types/index.ts`
- `backend/src/types/index.ts`

### 1.4 依存関係図
```
フロントエンド場所選択
    ↓
LocationContext (現在地状態管理)
    ↓
Chat API (メッセージ送信)
    ↓
ChatService (システムプロンプト生成)
    ↓
LocationsService (場所情報取得)
    ↓
Partner DB (現在地保存)
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- ホーム画面で選択した場所がシステムプロンプトに「現在の場所: ○○」として確実に反映される
- チャット画像生成時に場所に応じた服装・背景が自動適用される
- 場所情報の一元管理によるデータ整合性の確保
- エラーハンドリングの強化（場所データが取得できない場合の適切な処理）

### 2.2 維持すべき機能
- 既存の場所選択UI（ピンマーク）の動作
- LocationContextによる場所状態管理
- 親密度による場所解放システム
- 季節イベント機能
- チャット機能とメッセージ履歴
- 画像生成機能の基本動作

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
場所選択からシステムプロンプトまでの完全なデータフローを確立し、以下の流れで動作する：

1. **フロントエンド**: ユーザーがピンマークから場所を選択
2. **LocationContext**: 現在地状態を更新しAPIで永続化
3. **バックエンドDB**: パートナーの現在地を保存
4. **Chat API**: メッセージ送信時に現在地IDを含めて送信
5. **ChatService**: 現在地情報を取得してシステムプロンプトに反映
6. **ImagesService**: 現在地に応じた画像生成

### 3.2 核心的な改善ポイント
- **データ永続化の完全実装**: 選択した場所をDBに確実に保存
- **API連携の強化**: フロントエンドからバックエンドへの場所情報伝達を確実にする
- **エラー処理の追加**: 場所情報取得失敗時の適切なフォールバック
- **型安全性の向上**: 場所関連の型定義を両プロジェクトで同期

### 3.3 新しいディレクトリ構造
既存構造を維持。変更なし。

## 4. 実装計画

### フェーズ1: データベース構造とバックエンド修正
- **目標**: 場所情報の永続化基盤を確立
- **影響範囲**: バックエンドDB・Partner model・LocationsService
- **タスク**:
  1. **T1.1**: DBマイグレーション作成
     - 対象: `backend/migrations/add_current_location_to_partners.sql`
     - 実装: `partners`テーブルに`current_location_id`カラム追加
  2. **T1.2**: Partner modelの更新
     - 対象: `backend/src/db/models/Partner.model.ts`
     - 実装: `currentLocationId`フィールド追加、CRUD操作対応
  3. **T1.3**: LocationsService DB更新実装
     - 対象: `backend/src/features/locations/locations.service.ts:87`
     - 実装: コメントアウトされたDB更新処理を実装
- **検証ポイント**:
  - マイグレーションが正常に実行される
  - Partner modelで現在地の保存・取得ができる
  - LocationsService経由で現在地更新ができる

### フェーズ2: 型定義同期と拡張
- **目標**: フロントエンドとバックエンドの型整合性確保
- **影響範囲**: 両プロジェクトの型定義ファイル
- **タスク**:
  1. **T2.1**: バックエンド型定義更新
     - 対象: `backend/src/types/index.ts`
     - 実装: `Partner`型に`currentLocationId`追加、`SendMessageRequest`に`locationId`追加
  2. **T2.2**: フロントエンド型定義同期
     - 対象: `frontend/src/types/index.ts`
     - 実装: バックエンドと同じ型定義に更新
- **検証ポイント**:
  - 両プロジェクトの型定義が完全に同期している
  - TypeScriptコンパイルエラーがない

### フェーズ3: フロントエンドAPI連携修正
- **目標**: 場所情報を含むメッセージ送信の実装
- **影響範囲**: Chat API・ホーム画面・LocationContext
- **タスク**:
  1. **T3.1**: Chat API修正
     - 対象: `frontend/src/services/api/chat.api.ts:20-40`
     - 実装: `sendMessage`で`locationId`パラメータを送信
  2. **T3.2**: ホーム画面修正
     - 対象: `frontend/app/home/page.tsx:310-330`
     - 実装: メッセージ送信時に`currentLocation.id`を含める
  3. **T3.3**: LocationContext強化
     - 対象: `frontend/src/contexts/LocationContext.tsx:190-200`
     - 実装: 場所変更時のエラーハンドリング強化
- **検証ポイント**:
  - メッセージ送信時に現在地IDが正しく送信される
  - 場所変更時のエラーが適切に処理される
  - ネットワークエラー時の適切なフォールバック

### フェーズ4: バックエンド統合とシステムプロンプト反映
- **目標**: 現在地情報のシステムプロンプト確実反映
- **影響範囲**: ChatService・ImagesService
- **タスク**:
  1. **T4.1**: ChatService現在地取得強化
     - 対象: `backend/src/features/chat/chat.service.ts:362-398`
     - 実装: パートナーの保存済み現在地を取得してlocationIdとして使用
  2. **T4.2**: ImagesService場所情報統合
     - 対象: `backend/src/features/images/images.service.ts:280-302`
     - 実装: 現在地情報が無い場合のデフォルト値設定
  3. **T4.3**: エラーハンドリング追加
     - 対象: `backend/src/features/chat/chat.service.ts:394-397`
     - 実装: 場所情報取得失敗時の詳細ログとフォールバック
- **検証ポイント**:
  - システムプロンプトに「現在の場所: ○○」が含まれる
  - 場所情報取得失敗時もチャット機能が正常動作する
  - 画像生成で場所に応じた服装が反映される

## 5. 期待される効果

### 5.1 コード削減
特に大きなコード削減は期待されないが、コメントアウトされた未使用コードの削除で約10-15行の削減

### 5.2 保守性向上
- 場所情報の一元管理によるデータ整合性確保
- 型安全性の向上によるランタイムエラーの削減
- エラーハンドリングの統一による障害対応の効率化

### 5.3 拡張性改善
- 新しい場所追加時の影響範囲を最小化
- 場所に応じた機能追加（BGM、特別なイベントなど）の基盤確立
- システムプロンプトの動的生成機能の応用範囲拡大

## 6. リスクと対策

### 6.1 潜在的リスク
- **DBマイグレーション失敗**: 既存のパートナーデータに影響する可能性
- **API仕様変更**: フロントエンドとバックエンドの連携不具合
- **パフォーマンス影響**: メッセージ送信時の場所情報取得による遅延

### 6.2 対策
- **段階的なマイグレーション**: NOT NULL制約は後から追加
- **後方互換性維持**: locationIdが無い場合の適切なフォールバック実装
- **キャッシュ機能**: 場所情報の適切なキャッシュによる性能確保
- **徹底的なテスト**: 各フェーズでの動作確認とロールバック準備

## 7. 備考

### 検討事項
- 将来的にはリアルタイム位置情報（GPS）との連携も視野に入れる
- 場所履歴機能の追加可能性を考慮した設計とする
- マルチユーザー対応時の場所情報共有機能の拡張性を保持

### 代替案
- 現在地情報をセッションストレージで管理する軽量アプローチ
- GraphQLを使用したリアルタイム場所情報同期

この計画により、場所選択機能が完全に統合され、ユーザーの選択した場所がシステム全体で確実に反映されるようになります。