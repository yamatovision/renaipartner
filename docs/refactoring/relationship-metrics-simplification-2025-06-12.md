# リファクタリング計画: 関係性メトリクスの簡素化 2025-06-12

## 1. 現状分析

### 1.1 対象概要
関係性メトリクス（RelationshipMetrics）は、ユーザーとAIパートナー間の関係性を数値化する機能です。現在、3つのパラメータ（親密度、信頼度、感情的つながり）を管理していますが、実際に使用されているのは親密度のみです。

### 1.2 問題点と課題
- **未使用パラメータの存在**: 信頼度と感情的つながりは初期値のまま更新されない
- **不要なコードの肥大化**: 使われないメソッドやUI要素が残存
- **複雑性の増加**: 3つのパラメータ管理による不必要な複雑性
- **ユーザー体験の混乱**: 変化しない数値が表示され続ける

### 1.3 関連ファイル一覧
- `backend/src/types/index.ts` - RelationshipMetrics型定義
- `frontend/src/types/index.ts` - RelationshipMetrics型定義（同期必要）
- `backend/src/db/models/RelationshipMetrics.model.ts` - DBモデルと更新メソッド
- `backend/src/features/memory/memory.service.ts` - メトリクス取得処理
- `frontend/app/home/page.tsx` - UI表示部分（3つのメトリクス表示）
- `backend/tests/integration/memory/memory.flow.test.ts` - テストコード

### 1.4 依存関係図
```
RelationshipMetrics型定義
    ├── RelationshipMetricsModel（DBモデル）
    ├── MemoryService（API提供）
    └── HomePage（UI表示）
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- **コード削減**: 約200行（30%）のコード削減
- **シンプル化**: 1つのパラメータのみ管理する明快な実装
- **保守性向上**: 不要なメソッドと複雑性の排除
- **ユーザー体験改善**: 実際に変化するパラメータのみを表示

### 2.2 維持すべき機能
- 親密度（intimacyLevel）の管理と更新機能
- チャット時の親密度自動更新
- 関係性の段階判定（getRelationshipStage）

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
シンプルな単一パラメータ管理システムへ移行：
- RelationshipMetricsから親密度以外を削除
- 不要な更新メソッドを削除
- UIから信頼度・感情的つながりの表示を削除

### 3.2 核心的な改善ポイント
- 型定義を親密度中心に再構築
- データベースカラムは残すが、アプリケーション層では無視
- UIは親密度のみに焦点を当てた表示

### 3.3 新しいディレクトリ構造
変更なし（既存ファイル内での修正のみ）

## 4. 実装計画

### フェーズ1: 型定義の簡素化
- **目標**: RelationshipMetrics型から不要フィールドを削除
- **影響範囲**: 全ての関連ファイル
- **タスク**:
  1. **T1.1**: バックエンド型定義の更新
     - 対象: `backend/src/types/index.ts:524-533`
     - 実装: trustLevelとemotionalConnectionをオプショナルに変更
  2. **T1.2**: フロントエンド型定義の同期
     - 対象: `frontend/src/types/index.ts`の同じ箇所
     - 実装: バックエンドと同一の変更を適用
- **検証ポイント**:
  - TypeScriptコンパイルエラーがないこと
  - 既存の親密度更新処理が正常動作すること

### フェーズ2: データベースモデルの整理
- **目標**: 不要な更新メソッドを削除
- **影響範囲**: RelationshipMetricsModel
- **タスク**:
  1. **T2.1**: 不要メソッドの削除
     - 対象: `backend/src/db/models/RelationshipMetrics.model.ts`
     - 実装: updateTrustLevel、updateEmotionalConnection、updateMultipleMetricsから該当部分を削除
  2. **T2.2**: getRelationshipStageの簡素化
     - 対象: 同ファイル:369-378
     - 実装: 親密度のみで段階判定するロジックに変更
- **検証ポイント**:
  - 親密度更新が正常に動作すること
  - 段階判定が適切に機能すること

### フェーズ3: フロントエンドUIの簡素化
- **目標**: 親密度のみの表示に変更
- **影響範囲**: HomePage
- **タスク**:
  1. **T3.1**: メトリクス変化計算の削除
     - 対象: `frontend/app/home/page.tsx:192-205`
     - 実装: trust、emotionalの変化計算を削除
  2. **T3.2**: UI表示要素の削除
     - 対象: 同ファイル:745-797付近
     - 実装: 信頼度と感情的つながりの表示ブロックを削除
  3. **T3.3**: モックデータの整理
     - 対象: 同ファイル:221-233
     - 実装: フォールバック時のモックデータから不要フィールドを削除
- **検証ポイント**:
  - 親密度のみが表示されること
  - レイアウトが崩れていないこと

### フェーズ4: テストコードの修正
- **目標**: 削除した機能に関するテストを除去
- **影響範囲**: 統合テスト
- **タスク**:
  1. **T4.1**: メモリサービステストの修正
     - 対象: `backend/tests/integration/memory/memory.flow.test.ts`
     - 実装: trustLevel、emotionalConnectionに関するアサーションを削除
- **検証ポイント**:
  - 全てのテストがパスすること

## 5. 期待される効果

### 5.1 コード削減
- データベースモデル: 約100行削減（メソッド3つ分）
- フロントエンドUI: 約60行削減（表示ブロック2つ分）
- テストコード: 約40行削減
- **合計: 約200行削減（30%）**

### 5.2 保守性向上
- 単一パラメータ管理によるシンプルな実装
- 将来の拡張時も親密度を中心とした設計
- 不要な複雑性の排除

### 5.3 拡張性改善
- 必要になった時点で新パラメータを追加する柔軟性
- 既存の親密度システムを基盤とした拡張が容易

## 6. リスクと対策

### 6.1 潜在的リスク
- データベースカラムとの不整合
- 将来的に信頼度・感情的つながりが必要になる可能性

### 6.2 対策
- DBカラムは残し、アプリケーション層でのみ無視
- 型定義でオプショナルにすることで、将来の再追加に対応
- コード削除ではなくコメントアウトも検討（必要に応じて）

## 7. 備考
- データベーススキーマの変更は行わない（互換性維持のため）
- 将来的に必要になった場合は、削除したコードを参考に再実装可能
- 親密度のみでも十分な関係性表現が可能であることを確認済み