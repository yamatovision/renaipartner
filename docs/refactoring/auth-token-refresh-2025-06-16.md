# リファクタリング計画: 認証トークン自動更新システム 2025-06-16

## 1. 現状分析

### 1.1 対象概要
ユーザー認証システムは、JWTトークンベースの認証を採用しており、アクセストークン（15分）とリフレッシュトークン（30日）の2種類のトークンを使用している。現在、アクセストークンの期限切れ時に自動更新が行われず、ユーザーがサイレントにログアウトされる問題が発生している。

### 1.2 問題点と課題
- **アクセストークンの有効期限が15分と短すぎる**
  - ユーザーが15分間操作しないとトークンが期限切れになる
  - 根本原因：セキュリティを重視しすぎて、ユーザビリティが犠牲になっている

- **401エラー時の自動リトライ機能が未実装**
  - APIクライアントレベルでの統一的なエラーハンドリングが欠如
  - 根本原因：初期実装時に自動リフレッシュ機能の設計が漏れていた

- **エラー通知がサイレントに処理される**
  - ユーザーに認証エラーが通知されない
  - 根本原因：エラー処理が各コンポーネントに分散し、統一性がない

### 1.3 関連ファイル一覧
- `/backend/src/config/env.config.ts` - JWT設定
- `/backend/src/common/middlewares/auth.middleware.ts` - 認証ミドルウェア
- `/backend/src/features/auth/auth.service.ts` - 認証サービス
- `/frontend/src/services/api/client.ts` - APIクライアント
- `/frontend/src/services/api/auth.api.ts` - 認証APIサービス
- `/frontend/src/contexts/AuthContext.tsx` - 認証コンテキスト
- `/frontend/src/lib/auth.ts` - 認証ヘルパー関数

### 1.4 依存関係図
```
APIクライアント (client.ts)
    ↓
認証APIサービス (auth.api.ts)
    ↓
認証コンテキスト (AuthContext.tsx)
    ↓
各コンポーネント（PartnerGuard, AdminLayout等）
```

## 2. リファクタリングの目標

### 2.1 期待される成果
- **安定したログイン状態の維持**
  - 401エラー時の自動トークンリフレッシュ
  - ユーザーが意図的にログアウトするまでセッションを維持
  - トークン更新の透過的な処理

- **ユーザビリティの向上**
  - アクセストークンの有効期限を1時間に延長
  - バックグラウンドでの自動トークン更新
  - エラー時の適切なフィードバック

### 2.2 維持すべき機能
- 既存の認証フロー（ログイン、ログアウト、パスワード変更）
- セキュリティレベル（HTTPOnly Cookie、CORS設定）
- ロールベースアクセス制御

## 3. 理想的な実装

### 3.1 全体アーキテクチャ
```
1. APIクライアントにインターセプター機能を追加
2. 401エラー検出時に自動的にリフレッシュトークンで再認証
3. リフレッシュ成功時は元のリクエストを自動リトライ
4. リフレッシュ失敗時のみログインページへリダイレクト
```

### 3.2 核心的な改善ポイント
- **APIクライアントの拡張**: fetchラッパーに401エラーハンドリングを統合
- **トークン有効期限の調整**: 15分→1時間に延長
- **プロアクティブなトークン更新**: 有効期限5分前に自動更新

### 3.3 新しいディレクトリ構造
```
frontend/src/
├── services/
│   └── api/
│       ├── client.ts (拡張版APIクライアント)
│       └── interceptors.ts (新規：エラーインターセプター)
└── lib/
    └── token-manager.ts (新規：トークン管理ユーティリティ)
```

## 4. 実装計画

### フェーズ1: バックエンドのトークン設定調整
- **目標**: アクセストークンの有効期限を延長し、安定性を向上
- **影響範囲**: 環境設定ファイル
- **タスク**:
  1. **T1.1**: アクセストークンの有効期限を1時間に変更
     - 対象: `/backend/src/config/env.config.ts`
     - 実装: JWT_ACCESS_TOKEN_EXPIRY を '15m' → '1h' に変更
- **検証ポイント**:
  - 新規ログイン時にトークンの有効期限が1時間になっていること
  - 既存の認証フローが正常に動作すること

### フェーズ2: APIクライアントの拡張
- **目標**: 401エラー時の自動リトライ機能を実装
- **影響範囲**: APIクライアント、認証サービス
- **タスク**:
  1. **T2.1**: トークン管理ユーティリティの作成
     - 対象: `/frontend/src/lib/token-manager.ts` (新規)
     - 実装: リフレッシュトークンの状態管理とリトライロジック
  2. **T2.2**: APIクライアントにインターセプター機能を追加
     - 対象: `/frontend/src/services/api/client.ts`
     - 実装: 401エラー検出時の自動リフレッシュとリトライ
  3. **T2.3**: 認証APIサービスの調整
     - 対象: `/frontend/src/services/api/auth.api.ts`
     - 実装: リフレッシュ機能のエクスポートと共有
- **検証ポイント**:
  - アクセストークン期限切れ時に自動的にリフレッシュされること
  - リフレッシュ後に元のAPIリクエストが成功すること
  - リフレッシュトークンも期限切れの場合はログインページへリダイレクトすること

### フェーズ3: プロアクティブなトークン更新
- **目標**: トークン期限切れを未然に防ぐ
- **影響範囲**: 認証コンテキスト
- **タスク**:
  1. **T3.1**: AuthContextにトークン更新タイマーを実装
     - 対象: `/frontend/src/contexts/AuthContext.tsx`
     - 実装: トークン有効期限の5分前に自動更新するタイマー
  2. **T3.2**: バックグラウンドでのトークン更新処理
     - 対象: `/frontend/src/contexts/AuthContext.tsx`
     - 実装: ページ遷移や操作に影響しない静かな更新処理
- **検証ポイント**:
  - 長時間アプリを使用してもログイン状態が維持されること
  - トークン更新がユーザー操作を妨げないこと

## 5. 期待される効果

### 5.1 コード削減
- 各コンポーネントでの個別エラーハンドリングコードを削除
- 推定削減量：約200行（各コンポーネントの認証エラー処理）

### 5.2 保守性向上
- 認証エラー処理が一箇所に集約される
- トークン管理ロジックが明確に分離される
- 将来的な認証方式の変更が容易になる

### 5.3 拡張性改善
- 新しいAPIエンドポイントを追加しても自動的に401エラー処理が適用される
- 認証方式の変更（OAuth等）への移行が容易

## 6. リスクと対策

### 6.1 潜在的リスク
- **既存セッションへの影響**: トークン有効期限変更により既存ユーザーがログアウトされる可能性
- **セキュリティリスク**: トークン有効期限延長によるセキュリティ低下
- **無限リトライ**: リフレッシュ失敗時の無限ループ

### 6.2 対策
- **段階的リリース**: まず開発環境でテスト後、本番環境へ適用
- **セキュリティ監査**: リフレッシュトークンの適切な管理とHTTPOnly Cookieの維持
- **リトライ制限**: リフレッシュは1回のみ試行し、失敗時は即座にログアウト

## 7. 備考
- 実装完了後、全画面での長時間操作テストを実施すること
- モバイルブラウザでのバックグラウンド動作も考慮すること
- 将来的にはWebSocketを使用したリアルタイム認証状態同期も検討