# 機能拡張計画: ログイン時初期位置システム 2025-06-15

## 1. 拡張概要

現在、ログイン時のAI初期位置が「教室」に固定されており、時間帯や曜日を考慮していない問題を解決する。現実的な生活パターンに基づいて、時間帯・曜日・親密度を組み合わせた動的な初期位置選択システムを実装し、より自然で没入感のあるユーザー体験を提供する。

## 2. 詳細仕様

### 2.1 現状と課題

**現在の実装状況:**
- ログイン時は常に「教室」に固定（LocationContext.tsx:141行目でハードコード）
- 各場所には`timeOfDay`プロパティがあるが現在は使用されていない
- 親密度による場所の解放制御は実装済み
- 時間による動的な位置変更は未実装
- 場所選択時に時間制約のチェックなし

**課題:**
- 夜間でも「教室」にいるのは不自然
- 平日と休日の区別がない
- せっかくの`timeOfDay`設定が活用されていない
- 毎回同じ場所で単調

### 2.2 拡張内容

**1. 自宅の親密度調整と名称変更**
- 自宅リビング：親密度70 → 0に変更、名前を「自宅」に変更
- 理由：夜間・朝の安全な初期位置として確保
- ベッドルーム（夜）：親密度85のまま維持（高親密度専用）

**2. 時間帯・曜日・親密度による初期位置ルール**
```
【平日】
- 朝（6:00-11:59）: 教室、学校図書館
- 昼（12:00-17:59）: 教室、学校図書館、カフェ、公園
- 夕方（18:00-21:59）: カフェ、レストラン、自宅
- 夜（22:00-5:59）: 自宅

【休日】
- 朝（6:00-11:59）: 自宅、カフェ
- 昼（12:00-17:59）: カフェ、公園、美術館、遊園地、ビーチ
- 夕方（18:00-21:59）: カフェ、レストラン、自宅
- 夜（22:00-5:59）: 自宅
```

**3. ランダム選択ロジック**
- 時間帯＋曜日で候補場所を絞り込み
- 候補の中から親密度範囲内の場所を抽出
- 抽出された場所からランダムに選択

**4. 場所選択時の時間制約**
- ユーザーが手動で場所を変更する際も時間制約を適用
- 不適切な時間帯の場所は選択不可

## 3. ディレクトリ構造

新機能は既存ファイルの修正で対応し、ファイル肥大化を避ける構造：

```
backend/src/features/locations/
├── locations-data.ts                 # 自宅系親密度を0に変更
├── locations.service.ts              # 時間帯・曜日判定ロジック追加
└── locations.controller.ts           # API仕様は変更なし

frontend/src/contexts/
├── LocationContext.tsx               # 初期位置ロジックの大幅修正
└── AuthContext.tsx                   # ログイン時の初期位置設定連携

frontend/src/utils/
└── timeUtils.ts                      # 新規：時間帯・曜日判定ユーティリティ

frontend/src/types/
└── index.ts                          # TimeOfDay、WeekdayType型の追加
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: LocationContext、AuthContext、場所選択UI
- **バックエンド**: locations-data.ts、locations.service.ts
- **データモデル**: 型定義の追加（TimeOfDay、WeekdayType）
- **その他**: 既存の場所選択機能の動作変更

### 4.2 変更が必要なファイル

```
- backend/src/features/locations/locations-data.ts: 自宅の親密度を0に変更＋名前変更
- backend/src/features/locations/locations.service.ts: 時間帯・曜日判定ロジック追加
- frontend/src/contexts/LocationContext.tsx: 初期位置選択ロジックの完全刷新
- frontend/src/contexts/AuthContext.tsx: ログイン時の初期位置設定連携
- frontend/src/utils/timeUtils.ts: 新規作成 - 時間帯・曜日判定ユーティリティ
- frontend/src/types/index.ts: TimeOfDay、WeekdayType型の追加
- backend/src/types/index.ts: フロントエンドと同期
```

## 5. タスクリスト

```
- [ ] **T1**: 型定義の追加（TimeOfDay、WeekdayType）
- [ ] **T2**: timeUtils.tsの作成（時間帯・曜日判定ロジック）
- [ ] **T3**: locations-data.tsの自宅親密度修正＋名前「自宅」に変更
- [ ] **T4**: LocationContextの初期位置ロジック修正
- [ ] **T5**: 場所選択時の時間制約チェック実装
- [ ] **T6**: AuthContextとの連携実装
- [ ] **T7**: 統合テスト実施
```

## 6. テスト計画

**テストケース:**

1. **時間帯別初期位置テスト**
   - 各時間帯でログインして適切な場所が選択されるか
   - 親密度0の状態で全時間帯テスト
   - 親密度50の状態で選択肢が増えるかテスト

2. **曜日判定テスト**
   - 平日と休日で異なる場所が選択されるか
   - システム日時を変更してテスト

3. **ランダム性テスト**
   - 同じ条件で複数回ログインして異なる場所が選択されるか

4. **制約チェックテスト**
   - 不適切な時間帯の場所が選択不可になるか
   - 親密度不足の場所が除外されるか

5. **エッジケーステスト**
   - 候補場所が0の場合の動作
   - システム時刻変更時の動作

## 7. SCOPE_PROGRESSへの統合

SCOPE_PROGRESS.mdに以下のタスクとして統合：

```markdown
- [ ] **EXT-LOGIN-LOC**: ログイン時初期位置システムの実装
  - 目標: 2025-06-15
  - 参照: [/docs/extensions/ext-login-location-system-2025-06-15.md]
  - 内容: 時間帯・曜日・親密度に基づく動的初期位置選択とUI制約の実装
```

## 8. 備考

**実装上の注意点:**
- 自宅の親密度変更により、既存ユーザーの体験が大きく変わる
- 時間制約により一部ユーザーが困惑する可能性（UI説明の充実が必要）
- ランダム性により再現性のあるバグ報告が困難になる可能性

**将来的な拡張案:**
- 季節や天候による場所制約
- ユーザーの行動履歴に基づく学習型初期位置選択
- 特定イベント期間中の特別な初期位置ルール