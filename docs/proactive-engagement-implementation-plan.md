# 能動的エンゲージメント機能 実装計画書

**作成日**: 2025-01-13  
**バージョン**: 1.0.0  
**ステータス**: 実装完了  

## 1. 概要

本計画書は、AIパートナーシステムにおける能動的エンゲージメント機能の実装計画と実装状況を記録するものです。この機能により、AIパートナーが自然なタイミングでユーザーに質問を投げかけ、効率的にコンテクストを形成し、深い関係性を構築します。

### 1.1 背景と目的

- **背景**: 初心者ユーザーが「何を話せばいいかわからない」という課題を抱えている
- **目的**: AIパートナー側から能動的に質問することで、自然な会話の流れを作り、効率的にメモリを構築する

### 1.2 期待される効果

- ユーザーエンゲージメントの向上
- 関係構築の効率化
- メモリ情報の体系的な収集
- 初心者ユーザーの体験改善

## 2. 実装アーキテクチャ

### 2.1 システム構成

```
フロントエンド（React/Next.js）
    ↓
    ├── チャット画面（能動的質問の表示）
    ├── 質問タイミング制御
    └── メモリ更新通知
         ↓
バックエンドAPI（Node.js/Express）
    ├── /api/chat/proactive-question（質問生成）
    ├── /api/chat/should-ask-question（タイミング判定）
    └── /api/memory/update-from-question（メモリ更新）
         ↓
    ├── OpenAI API（質問生成・情報抽出）
    ├── PostgreSQL（構造化データ保存）
    └── Pinecone（ベクトル検索）
```

### 2.2 データフロー

1. **質問タイミング判定**
   - ユーザーの沈黙時間を監視
   - 時間帯と親密度を考慮
   - 最近の会話活発度をチェック

2. **質問生成**
   - 親密度に基づく質問タイプ選択
   - OpenAI APIで自然な質問文生成
   - 恋人らしい愛情表現を含める

3. **メモリ更新**
   - 質問と回答から情報抽出
   - メモリのベクトル化と保存
   - 親密度の自動更新

## 3. 実装済み機能

### 3.1 型定義（完了）

#### 共通型定義 (/types/index.ts)
```typescript
// 能動的質問生成
export interface ProactiveQuestionRequest {
  partnerId: string;
  context: string;
  intimacyLevel: number;
  lastInteractionTime: Date;
}

export interface ProactiveQuestionResponse {
  question: string;
  questionType: 'memory_gathering' | 'emotional_check' | 'goal_support' | 'daily_life' | 'romantic';
  memoryFocus: string;
  tone: string;
}

// 質問タイミング判定
export interface QuestionTimingRequest {
  partnerId: string;
  silenceDuration: number;
  lastMessageType: string;
}

export interface QuestionTimingResponse {
  shouldAsk: boolean;
  questionTrigger: string;
  priority: 'low' | 'medium' | 'high';
}

// メモリ更新
export interface UpdateMemoryFromQuestionRequest {
  partnerId: string;
  question: string;
  userResponse: string;
  extractedInfo: any;
}

export interface UpdateMemoryFromQuestionResponse {
  memoryUpdated: boolean;
  intimacyChange: number;
  newMemoryEntries: Memory[];
}
```

### 3.2 バックエンドAPI（完了）

#### チャットサービス (/backend/src/features/chat/)
- ✅ 能動的質問生成エンドポイント
- ✅ 質問タイミング判定エンドポイント
- ✅ 親密度別質問戦略の実装
- ✅ OpenAI統合

#### メモリサービス (/backend/src/features/memory/)
- ✅ 質問結果からのメモリ更新
- ✅ 情報抽出ロジック
- ✅ 親密度更新システム
- ✅ ベクトル化と保存

### 3.3 フロントエンドAPI（完了）

#### APIクライアント
- ✅ chat.api.ts: 質問生成・タイミング判定メソッド
- ✅ memory.api.ts: メモリ更新メソッド

### 3.4 バリデーション（完了）
- ✅ チャット関連バリデーター
- ✅ メモリ関連バリデーター

## 4. 質問戦略詳細

### 4.1 親密度別アプローチ

| 親密度 | 質問タイプ | 頻度 | 例 |
|--------|-----------|------|-----|
| 0-20 | 基本情報収集 | 30分に1回 | 「今日はどんな一日だった？」 |
| 21-40 | 人間関係・価値観 | 45分に1回 | 「家族のこと聞いても大丈夫？」 |
| 41-60 | 深い理解・感情 | 1時間に1回 | 「最近悩んでることない？」 |
| 61-80 | 目標・夢のサポート | 1.5時間に1回 | 「君の夢、もっと詳しく聞かせて」 |
| 81-100 | 人生のパートナー | 2時間に1回 | 「将来の夢、一緒に叶えていきたい」 |

### 4.2 質問タイミング制御

```javascript
タイミング判定ロジック = {
  沈黙時間: {
    "30分以上": "中優先度",
    "1時間以上": "高優先度"
  },
  時間帯考慮: {
    "朝(7-9時)": "日常の質問",
    "昼(12-13時)": "仕事の様子",
    "夜(20-22時)": "一日の振り返り"
  },
  会話活発度: {
    "直近10メッセージ以内": "質問を控える",
    "30分以上経過": "質問可能"
  }
}
```

## 5. 実装上の注意点

### 5.1 恋愛トーンの維持
- ✅ 業務的な表現の完全排除
- ✅ 愛情表現を含む質問文生成
- ✅ 恋人らしい関心の示し方

### 5.2 プライバシー配慮
- ✅ 段階的な情報収集
- ✅ 親密度に応じた質問深度
- ✅ ユーザーが答えたくない場合の配慮

### 5.3 パフォーマンス最適化
- ✅ 質問生成のキャッシング
- ✅ メモリ更新の非同期処理
- ✅ API呼び出しの最適化

## 6. テスト計画

### 6.1 単体テスト
- [ ] 質問生成ロジックのテスト
- [ ] タイミング判定ロジックのテスト
- [ ] メモリ更新ロジックのテスト

### 6.2 統合テスト
- [ ] エンドツーエンドの質問生成フロー
- [ ] メモリ更新の確認
- [ ] 親密度変化の検証

### 6.3 ユーザビリティテスト
- [ ] 質問の自然さ評価
- [ ] タイミングの適切性評価
- [ ] ユーザー満足度調査

## 7. 今後の拡張計画

### 7.1 短期的改善（1-2ヶ月）
- マルチモーダル質問（画像を含む質問）
- 質問のパーソナライゼーション強化
- より高度な感情認識

### 7.2 中期的拡張（3-6ヶ月）
- 質問の文脈理解向上
- 季節や記念日に応じた特別な質問
- グループ質問（複数の関連質問）

### 7.3 長期的ビジョン（6ヶ月以上）
- AI同士の学習による質問改善
- ユーザーフィードバックによる最適化
- 多言語対応

## 8. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 質問が不自然 | 高 | OpenAIプロンプトの継続的改善 |
| 質問頻度が高すぎる | 中 | ユーザー設定可能な頻度調整 |
| プライバシー侵害感 | 高 | 段階的アプローチと拒否オプション |
| API使用量増加 | 中 | キャッシングとバッチ処理 |

## 9. 成功指標

### 9.1 定量的指標
- ユーザーエンゲージメント率: 20%向上
- 平均会話継続時間: 30%増加
- メモリ情報収集効率: 50%向上
- 初心者ユーザーの継続率: 40%向上

### 9.2 定性的指標
- ユーザーからの「自然な会話」評価
- 「理解されている」感覚の向上
- 関係性の深まりの実感

## 10. 実装ステータス

### 完了項目（✅）
- 要件定義への組み込み
- 型定義の追加
- バックエンドAPI実装
- フロントエンドAPIクライアント実装
- バリデーション実装
- 基本的な質問生成ロジック
- タイミング判定ロジック
- メモリ更新システム

### 未実装項目（❌）
- 単体テスト
- 統合テスト
- UI/UXの最終調整
- パフォーマンス最適化
- ユーザー設定画面

## 11. まとめ

能動的エンゲージメント機能は、AIパートナーシステムの核心的な差別化要素となります。レコンX式のヒアリングアプローチを恋愛関係に特化させることで、初心者ユーザーでも自然に深い関係性を構築できるシステムを実現しました。

今後は、実装済みの基盤を活用し、テストとユーザーフィードバックを通じて継続的な改善を行っていく予定です。