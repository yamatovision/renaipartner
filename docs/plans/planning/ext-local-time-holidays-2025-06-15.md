# 機能拡張計画: ローカル時間・祝日情報システムプロンプト追加 2025-06-15

## 1. 拡張概要

AIパートナーとの会話をより自然で状況に応じたものにするため、ユーザーのローカル時間と祝日・記念日情報をシステムプロンプトに追加します。これにより、時間帯に応じた挨拶、特別な日への言及、季節感のある会話が可能になります。

## 2. 詳細仕様

### 2.1 現状と課題

現在のシステムプロンプトには時刻情報が含まれていないため、AIパートナーは時間帯や特別な日を認識できません。これにより、朝なのに「おやすみ」と言ったり、クリスマスなのに通常通りの会話をしたりする不自然さがあります。

### 2.2 拡張内容

1. **ローカル時間情報の追加**
   - フォーマット: 「2025/6/14(日)14:30」
   - ユーザーのブラウザ時刻を使用
   - システムプロンプトの「現在の状況」セクションに追加

2. **祝日・記念日情報の追加**
   - 日本の祝日（元日、成人の日、建国記念の日など）
   - カップル向けイベント（バレンタインデー、ホワイトデー、クリスマスなど）
   - 該当する場合のみシステムプロンプトに含める

## 3. ディレクトリ構造

```
backend/
├── src/
│   ├── features/
│   │   ├── holidays/                    # 新規作成
│   │   │   ├── holidays-data.ts       # 祝日・記念日データ
│   │   │   └── holidays.service.ts    # 祝日判定サービス
│   │   └── chat/
│   │       ├── chat.controller.ts      # 更新
│   │       └── chat.service.ts         # 更新
│   └── types/
│       └── index.ts                    # 更新

frontend/
├── src/
│   ├── utils/                          # 新規作成
│   │   └── date.utils.ts              # 日付・時刻ユーティリティ
│   ├── services/
│   │   └── api/
│   │       └── chat.api.ts            # 更新
│   └── types/
│       └── index.ts                   # 更新
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: チャットメッセージ送信処理、型定義
- **バックエンド**: チャットAPI、システムプロンプト生成、型定義
- **データモデル**: ChatMessageRequest/SendMessageRequestインターフェース
- **その他**: なし

### 4.2 変更が必要なファイル

```
- frontend/src/types/index.ts: localDateTimeフィールドの追加
- backend/src/types/index.ts: localDateTimeフィールドの追加
- frontend/src/services/api/chat.api.ts: ローカル時刻を含めたリクエスト送信
- backend/src/features/chat/chat.controller.ts: localDateTimeの受け取り
- backend/src/features/chat/chat.service.ts: buildSystemPromptメソッドの更新
```

## 5. タスクリスト

```
- [ ] **T1**: 型定義の更新（フロントエンド・バックエンド同期）
- [ ] **T2**: 祝日・記念日データの作成（holidays-data.ts）
- [ ] **T3**: 祝日判定サービスの実装（holidays.service.ts）
- [ ] **T4**: 日付ユーティリティの実装（date.utils.ts）
- [ ] **T5**: フロントエンドのチャットAPI更新
- [ ] **T6**: バックエンドのチャットコントローラー更新
- [ ] **T7**: システムプロンプト生成ロジックの更新
- [ ] **T8**: 統合テストの実施
```

## 6. テスト計画

1. **単体テスト**
   - 祝日判定サービスのテスト（各祝日・記念日の判定）
   - 日付フォーマットのテスト

2. **統合テスト**
   - 時刻情報がシステムプロンプトに正しく含まれることを確認
   - 祝日・記念日がある日の動作確認
   - タイムゾーンの異なる環境での動作確認

3. **手動テスト**
   - 実際のチャット画面で時間帯に応じた会話を確認
   - 祝日・記念日の会話内容を確認

## 7. SCOPE_PROGRESSへの統合

```markdown
- [ ] **EXT-001**: ローカル時間・祝日情報システムプロンプト追加の実装
  - 目標: 2025-06-16
  - 参照: [/docs/plans/planning/ext-local-time-holidays-2025-06-15.md]
  - 内容: ユーザーのローカル時間と祝日・記念日情報をシステムプロンプトに追加し、より自然な会話を実現
```

## 8. 備考

- 将来的には、ユーザーが独自の記念日を設定できる機能の追加も検討
- 国際化対応を行う場合は、各国の祝日データの管理方法を再検討する必要がある
- パフォーマンスへの影響は最小限と予想されるが、祝日判定のキャッシュ機構を検討してもよい