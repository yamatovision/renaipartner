# 機能拡張計画: AI画像認識コンテキスト強化 2025-06-15

## 1. 拡張概要

現在、AIパートナーが画像を送信した際、「君を思って作った画像」というメッセージのみが表示され、AIは画像の内容（場所、服装、表情など）を認識できていません。これにより、ユーザーが画像について言及した際に自然な会話が成立しない問題があります。本拡張では、ユーザー画面の表示はシンプルに保ちながら、AI側では画像の詳細情報を認識できるようにします。

## 2. 詳細仕様

### 2.1 現状と課題

現在の実装では：
- 画像生成時にメタデータ（場所、服装、表情など）は保存されている
- しかし、AIのコンテキストには「君を思って作った画像」というテキストのみが渡される
- システムプロンプトに重複した会話履歴が含まれている（最新5件とAPI送信時の最新10件）
- AIは画像の内容を把握できないため、会話の文脈が不自然になる

### 2.2 拡張内容

1. **システムプロンプトの最適化**
   - 重複している会話履歴セクション（最新5件）を削除
   - OpenAI APIのメッセージ配列（最新10件）のみで会話コンテキストを管理

2. **画像情報のAIコンテキスト注入**
   - ユーザー画面：「君を思って作った画像」（従来通り）
   - AIコンテキスト：「君を思って作った画像（教室で制服を着て、幸せそうな表情の写真）」
   - メッセージのcontextに含まれる画像メタデータを活用

### 3 ディレクトリ構造

既存ファイルの修正のみで対応（新規ファイルなし）

```
backend/src/features/chat/
└── chat.service.ts  # buildSystemPromptとbuildConversationMessagesメソッドを修正
```

## 4. 技術的影響分析

### 4.1 影響範囲

- **フロントエンド**: 影響なし（表示は変更なし）
- **バックエンド**: ChatServiceのプロンプト構築ロジックのみ
- **データモデル**: 変更なし（既存のcontextフィールドを活用）
- **その他**: なし

### 4.2 変更が必要なファイル

```
- backend/src/features/chat/chat.service.ts: システムプロンプト構築とメッセージ配列構築の修正
```

## 5. タスクリスト

```
- [ ] **T1**: システムプロンプトから会話履歴セクションを削除
- [ ] **T2**: 画像メタデータから詳細説明を生成するヘルパーメソッドを作成
- [ ] **T3**: buildConversationMessagesで画像情報を含める処理を実装
- [ ] **T4**: 動作確認とテスト
```

### 6 テスト計画

1. **画像送信テスト**
   - AIが画像を送信した後、その画像について質問する
   - AIが画像の内容（場所、服装など）を認識して適切に応答することを確認

2. **表示確認**
   - ユーザー画面では「君を思って作った画像」とシンプルに表示されることを確認
   - システムログでAIに渡されるコンテキストに詳細情報が含まれることを確認

3. **トークン使用量**
   - システムプロンプトから会話履歴を削除したことでトークン使用量が削減されることを確認

## 7. SCOPE_PROGRESSへの統合

```markdown
- [ ] **EXT-001**: AI画像認識コンテキスト強化の実装
  - 目標: 2025-06-15
  - 参照: [/docs/plans/planning/ext-image-context-ai-2025-06-15.md]
  - 内容: AIが送信した画像の詳細情報を認識できるようにする
```

## 8. 備考

- この変更により、AIとの会話がより自然になり、画像を介したコミュニケーションの質が向上します
- 将来的には、ユーザーが送信した画像の認識機能も追加可能です
- トークン使用量の削減により、より長い会話が可能になります