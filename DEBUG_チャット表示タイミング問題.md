# チャット表示タイミング問題 - デバッグ分析

## 問題の概要
ユーザーがhttp://localhost:3000/homeで会話すると、発言履歴がアシスタントの発言と同時に表示され、テンポがおかしくなる。

## 問題の原因
バックエンドのAPIレスポンス（`newMessages`配列）にユーザーメッセージとAIメッセージの両方が含まれているため、フロントエンドで二重にユーザーメッセージが表示される。

## ファイル依存関係マップ

### フロントエンド
```
/frontend/app/home/page.tsx (メインチャット画面)
    ├── /frontend/src/services/api/chat.api.ts (API呼び出し)
    ├── /frontend/src/services/api/client.ts (HTTPクライアント)
    └── /frontend/src/types/index.ts (型定義)
```

### バックエンド
```
/backend/src/features/chat/
    ├── chat.controller.ts (APIエンドポイント)
    ├── chat.service.ts (ビジネスロジック)
    └── chat.routes.ts (ルート定義)
```

## メッセージフローの詳細

### 1. 初期メッセージ読み込み
- `useEffect`でページロード時に`loadPartnerAndMessages`を実行
- `chatService.getMessages`で履歴を取得
- 取得したメッセージを`setMessages`で状態更新

### 2. メッセージ送信時のフロー
1. ユーザーがメッセージを送信
2. `sendMessage`関数が実行される
3. ユーザーメッセージをローカルで作成（line 354-361）
4. APIに送信（`chatService.sendMessage`）
5. バックエンドでAI応答生成
6. レスポンスの`newMessages`配列を既存メッセージに追加

## 問題の可能性

### 1. メッセージ追加のタイミング
- line 408-414で`setMessages`を使用してメッセージを追加
- APIレスポンスに含まれる`newMessages`にユーザーとAIの両方が含まれている
- これにより、履歴とAI応答が同時に表示される可能性

### 2. 状態更新の競合
- 複数の`setMessages`呼び出しが短時間に発生
- React の状態更新がバッチ処理される可能性

## 実装した修正

### フロントエンド側の修正（完了）
1. **ユーザーメッセージの即座表示**（line 368-372）
   - メッセージ送信時、APIコール前にユーザーメッセージを画面に追加
   - これによりユーザー体験が向上（即座にフィードバック）

2. **AIメッセージのみをフィルタリング**（line 414-424）
   - APIレスポンスから`sender === 'partner'`のメッセージのみを抽出
   - ユーザーメッセージの重複表示を防止

### バックエンド側の修正（オプション）
現在、バックエンドは`newMessages`配列に両方のメッセージを含めているが、これは以下の理由で変更しない方が良い：
- 既存のAPIクライアントとの互換性維持
- メッセージの完全性（トランザクション的な整合性）
- 他の画面やモバイルアプリでの利用を考慮

## テスト手順
1. npm run dev でフロントエンドを起動
2. http://localhost:3000/home にアクセス
3. メッセージを送信し、以下を確認：
   - ユーザーメッセージが即座に表示される
   - AIの応答が適切なタイミングで表示される
   - メッセージの重複がない