# 画面リロード問題デバッグ調査

## 問題の症状
- ユーザーがメッセージを送信すると画面全体がリロードされるような表示
- スムーズな体験ではない

## 関連ファイルと依存関係の調査

### メインファイル: frontend/app/home/page.tsx

#### State管理の複雑性
- 多数のuseStateフック（20個以上）
- messages, inputMessage, isTyping, sending, loading などが相互に影響

#### 疑わしい箇所の特定

1. **sendMessage関数内のstate更新 (line 273-393)**
   - setMessages が複数回呼ばれている
   - setIsTyping(true) → setIsTyping(false) の切り替え
   - 複数のstate更新が同期的に実行されている

2. **useEffect依存関係 (line 396-400)**
   - messagesが変更されるたびにスクロール処理が実行
   - 大量のメッセージがある場合、スクロール処理が重い可能性

3. **メッセージ追加処理の複雑性 (line 291-357)**
   - ユーザーメッセージを即座に追加
   - その後APIレスポンスでAIメッセージを追加
   - 2段階のstate更新が連続実行

### 考えられる原因

1. **React Batch更新の問題**
   - 非同期処理中の複数state更新がバッチされていない
   - 各state更新で再レンダリングが発生

2. **メッセージリスト更新時の重いレンダリング**
   - 大量のメッセージ要素の再レンダリング
   - key属性による効率的な更新ができていない

3. **scroll処理の実行タイミング**
   - useEffectでのscroll処理がレンダリングブロック

### 実装済みの最適化
1. ✅ sendMessage関数内にレンダリングデバッグログ追加
2. ✅ React.memo化されたMessageItemコンポーネント作成
3. ✅ useCallbackでsendMessage関数を最適化
4. ✅ state更新のバッチ化実装
5. ✅ formatTime関数を外部に移動してメモ化

### 修正内容詳細
- **MessageItemコンポーネント**: React.memoで個別メッセージのレンダリングを最適化
- **sendMessage関数**: useCallbackで依存関係を明確化し、不要な再作成を防止
- **state更新バッチ化**: 複数のstate更新を同時実行してレンダリング回数を削減
- **詳細ログ**: レンダリングタイミングの追跡ログを追加

### テスト手順
1. ブラウザ開発者ツールでコンソールログを確認
2. メッセージ送信時のレンダリング回数をチェック
3. レンダリングパフォーマンスの改善を確認